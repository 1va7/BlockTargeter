(function(m,v){typeof exports=="object"&&typeof module!="undefined"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(m=typeof globalThis!="undefined"?globalThis:m||self,v(m.QuickjsEmscriptenSync={}))})(this,function(m){"use strict";var ve=Object.defineProperty;var we=(m,v,j)=>v in m?ve(m,v,{enumerable:!0,configurable:!0,writable:!0,value:j}):m[v]=j;var c=(m,v,j)=>(we(m,typeof v!="symbol"?v+"":v,j),j);const v=n=>{const e=new j(n);return new Proxy(n,{get(t,s,r){return s in e?e[s]:Reflect.get(t,s,r)}})};class j{constructor(e){c(this,"context");c(this,"fn");c(this,"fnGenerator");c(this,"fnCounter",Number.MIN_SAFE_INTEGER);c(this,"fnMap",new Map);c(this,"newFunction",(e,t)=>{this.fnCounter++;const s=this.fnCounter;return this.fnMap.set(s,t),this.context.unwrapResult(this.context.callFunction(this.fnGenerator,this.context.undefined,this.context.newString(e),this.context.newNumber(t.length),this.context.newNumber(s),this.fn))});this.context=e;const t=this.fnMap;this.fn=this.context.newFunction("",function(s,...r){const o=e.getNumber(s),i=t.get(o);if(!i)throw new Error("function is not registered");return i.call(this,...r)}),this.fnGenerator=e.unwrapResult(e.evalCode(`((name, length, id, f) => {
        const fn = function(...args) {
          return f.call(this, id, ...args);
        };
        fn.name = name;
        fn.length = length;
        return fn;
      })`))}disposeEx(){this.fnGenerator.dispose(),this.fn.dispose()}}const k=[[Symbol,"Symbol"],[Symbol.prototype,"Symbol.prototype"],[Object,"Object"],[Object.prototype,"Object.prototype"],[Function,"Function"],[Function.prototype,"Function.prototype"],[Boolean,"Boolean"],[Boolean.prototype,"Boolean.prototype"],[Array,"Array"],[Array.prototype,"Array.prototype"],[Error,"Error"],[Error.prototype,"Error.prototype"],[EvalError,"EvalError"],[EvalError.prototype,"EvalError.prototype"],[RangeError,"RangeError"],[RangeError.prototype,"RangeError.prototype"],[ReferenceError,"ReferenceError"],[ReferenceError.prototype,"ReferenceError.prototype"],[SyntaxError,"SyntaxError"],[SyntaxError.prototype,"SyntaxError.prototype"],[TypeError,"TypeError"],[TypeError.prototype,"TypeError.prototype"],[URIError,"URIError"],[URIError.prototype,"URIError.prototype"],...Object.getOwnPropertyNames(Symbol).filter(n=>typeof Symbol[n]=="symbol").map(n=>[Symbol[n],`Symbol.${n}`])];function U(n,e){const t=n.unwrapResult(n.evalCode(e)),s=(r,...o)=>n.unwrapResult(n.callFunction(t,r!=null?r:n.undefined,...o));return s.dispose=()=>t.dispose(),s.alive=!0,Object.defineProperty(s,"alive",{get:()=>t.alive}),s}function _(n,e,t,...s){const r=U(n,e);try{return r(t,...s)}finally{r.dispose()}}function C(n,e,t){return n.dump(_(n,"Object.is",void 0,e,t))}function W(n,e,t){return n.dump(_(n,"(a, b) => a instanceof b",void 0,e,t))}function F(n,e){return n.dump(_(n,'a => typeof a === "object" && a !== null || typeof a === "function"',void 0,e))}function H(n,e){const t=JSON.stringify(e);return t?_(n,"JSON.parse",void 0,n.newString(t)):n.undefined}function z(n,e){try{return e(n)}finally{for(const t of n)t.alive&&t.dispose()}}function $([n,e],t){try{return t(n)}finally{e&&n.dispose()}}function O(n,e){try{return e(...n.map(t=>t[0]))}finally{for(const[t,s]of n)s&&t.dispose()}}function q(n){return"handle"in n}function Q(n){return q(n)?n.handle:n}function V(n,e,t,s){var o;let r;for(const i of s)if(r=i(e,n),r)break;return r?(o=t(e,r))!=null?o:r:void 0}function L(n,e){return typeof n!="symbol"?void 0:_(e,"d => Symbol(d)",void 0,n.description?e.newString(n.description):e.undefined)}function X(n,e){return n instanceof Date?_(e,"d => new Date(d)",void 0,e.newNumber(n.getTime())):void 0}const Y=[L,X];function N(n){return typeof n=="function"&&/^class\s/.test(Function.prototype.toString.call(n))}function g(n){return typeof n=="function"||typeof n=="object"&&n!==null}function S(n,e){const t=new Set,s=r=>{if(!(!g(r)||t.has(r)||(e==null?void 0:e(r,t))===!1)){if(t.add(r),Array.isArray(r)){for(const o of r)s(o);return}if(typeof r=="object"){const o=Object.getPrototypeOf(r);o&&o!==Object.prototype&&s(o)}for(const o of Object.values(Object.getOwnPropertyDescriptors(r)))"value"in o&&s(o.value),"get"in o&&s(o.get),"set"in o&&s(o.set)}};return s(n),t}function Z(n,e){return S(n,e?(t,s)=>s.size<e:void 0).size}function K(){let n=()=>{},e=()=>{};return{promise:new Promise((s,r)=>{n=s,e=r}),resolve:n,reject:e}}function A(n,e,t,s){const r=n.newObject(),o=(a,u)=>{const p=s(a),l=typeof u.value=="undefined"?void 0:s(u.value),f=typeof u.get=="undefined"?void 0:s(u.get),d=typeof u.set=="undefined"?void 0:s(u.set);n.newObject().consume(h=>{Object.entries(u).forEach(([y,b])=>{const w=y==="value"?l:y==="get"?f:y==="set"?d:b?n.true:n.false;w&&n.setProp(h,y,w)}),n.setProp(r,p,h)})},i=Object.getOwnPropertyDescriptors(e);Object.entries(i).forEach(([a,u])=>o(a,u)),Object.getOwnPropertySymbols(i).forEach(a=>o(a,i[a])),_(n,"Object.defineProperties",void 0,t,r).dispose(),r.dispose()}function x(n,e,t,s,r,o){var u;if(typeof e!="function")return;const i=n.newFunction(e.name,function(...p){const l=s(this),f=p.map(d=>s(d));if(N(e)&&g(l)){const d=new e(...f);return Object.entries(d).forEach(([h,y])=>{n.setProp(this,h,t(y))}),this}return t(o?o(e,l,f):e.apply(l,f))}).consume(p=>_(n,`Cls => {
          const fn = function(...args) { return Cls.apply(this, args); };
          fn.name = Cls.name;
          fn.length = Cls.length;
          return fn;
        }`,void 0,p)),a=(u=r(e,i))!=null?u:i;return A(n,e,i,t),a}function ee(n,e,t){var o;const s=H(n,e);return(o=t(e,s))!=null?o:s}function te(n,e,t,s){var u;if(typeof e!="object"||e===null)return;const r=Array.isArray(e)?n.newArray():n.newObject(),o=(u=s(e,r))!=null?u:r,i=Object.getPrototypeOf(e),a=i&&i!==Object.prototype&&i!==Array.prototype?t(i):void 0;return a&&_(n,"Object.setPrototypeOf",void 0,o,a).dispose(),A(n,e,r,t),o}function ne(n,e){switch(typeof e){case"undefined":return n.undefined;case"number":return n.newNumber(e);case"string":return n.newString(e);case"boolean":return e?n.true:n.false;case"object":return e===null?n.null:void 0}}function re(n,e,t,s){var o;if(!(e instanceof Promise))return;const r=n.newPromise();return e.then(i=>r.resolve(t(i)),i=>r.reject(t(i))),(o=s(e,r))!=null?o:r.handle}function E(n,e){var l,f,d,h,y;const{ctx:t,unmarshal:s,isMarshalable:r,find:o,pre:i}=e;{const b=ne(t,n);if(b)return b}{const b=o(n);if(b)return b}const a=r==null?void 0:r(n);if(a===!1)return t.undefined;const u=(b,w)=>i(b,w,a);if(a==="json")return ee(t,n,u);const p=b=>E(b,e);return(y=(h=(d=(f=V(t,n,u,[...Y,...(l=e.custom)!=null?l:[]]))!=null?f:re(t,n,p,u))!=null?d:x(t,n,p,s,u,e.preApply))!=null?h:te(t,n,p,u))!=null?y:t.undefined}function se(n,e,t,s){var o;let r;for(const i of s)if(r=i(e,n),r)break;return r?(o=t(r,e))!=null?o:r:void 0}function oe(n,e){if(e.typeof(n)!=="symbol")return;const t=e.getString(e.getProp(n,"description"));return Symbol(t)}function ie(n,e){if(!e.dump(_(e,"a => a instanceof Date",void 0,n)))return;const t=e.getNumber(_(e,"a => a.getTime()",void 0,n));return new Date(t)}const ue=[oe,ie];function D(n,e,t,s){n.newFunction("",(r,o)=>{const[i]=s(r);if(typeof i!="string"&&typeof i!="number"&&typeof i!="symbol")return;const a=[["value",!0],["get",!0],["set",!0],["configurable",!1],["enumerable",!1],["writable",!1]].reduce((u,[p,l])=>{const f=n.getProp(o,p),d=n.typeof(f);if(d==="undefined")return u;if(!l&&d==="boolean")return u[p]=n.dump(n.getProp(o,p)),u;const[h,y]=s(f);return y&&f.dispose(),u[p]=h,u},{});Object.defineProperty(t,i,a)}).consume(r=>{_(n,`(o, fn) => {
        const descs = Object.getOwnPropertyDescriptors(o);
        Object.entries(descs).forEach(([k, v]) => fn(k, v));
        Object.getOwnPropertySymbols(descs).forEach(k => fn(k, descs[k]));
      }`,void 0,e,r).dispose()})}function ae(n,e,t,s,r){var a;if(n.typeof(e)!=="function")return;const o=function(...u){return O([t(this),...u.map(p=>t(p))],(p,...l)=>{if(new.target){const[y]=s(_(n,"(Cls, ...args) => new Cls(...args)",p,e,...l));return Object.defineProperties(this,Object.getOwnPropertyDescriptors(y)),this}const f=n.unwrapResult(n.callFunction(e,p,...l)),[d,h]=s(f);return h&&f.dispose(),d})},i=(a=r(o,e))!=null?a:o;return D(n,e,o,s),i}function pe(n,e,t,s){var a;if(n.typeof(e)!=="object"||n.unwrapResult(n.evalCode("o => o === null")).consume(u=>n.dump(n.unwrapResult(n.callFunction(u,n.undefined,e)))))return;const r=_(n,"Array.isArray",void 0,e).consume(u=>n.dump(u))?[]:{},o=(a=s(r,e))!=null?a:r,i=_(n,`o => {
      const p = Object.getPrototypeOf(o);
      return !p || p === Object.prototype || p === Array.prototype ? undefined : p;
    }`,void 0,e).consume(u=>{if(n.typeof(u)==="undefined")return;const[p]=t(u);return p});return typeof i=="object"&&Object.setPrototypeOf(o,i),D(n,e,r,t),o}function fe(n,e){const t=n.typeof(e);return t==="undefined"||t==="number"||t==="string"||t==="boolean"?[n.dump(e),!0]:t==="object"&&n.unwrapResult(n.evalCode("a => a === null")).consume(r=>n.dump(n.unwrapResult(n.callFunction(r,n.undefined,e))))?[null,!0]:[void 0,!1]}function ce(n,e,t,s){var p;if(!le(n,e))return;const r=K(),[o,i]=t(r.resolve),[a,u]=t(r.reject);return _(n,"(p, res, rej) => { p.then(res, rej); }",void 0,e,o,a),i&&o.dispose(),u&&a.dispose(),(p=s(r.promise,e))!=null?p:r.promise}function le(n,e){return e.owner?n.unwrapResult(n.evalCode("Promise")).consume(t=>e.owner?W(n,e,t):!1):!1}function B(n,e){const[t]=T(n,e);return t}function T(n,e){var u,p,l,f;const{ctx:t,marshal:s,find:r,pre:o}=e;{const[d,h]=fe(t,n);if(h)return[d,!1]}{const d=r(n);if(d)return[d,!0]}const i=d=>T(d,e);return[(f=(l=(p=se(t,n,o,[...ue,...(u=e.custom)!=null?u:[]]))!=null?p:ce(t,n,s,o))!=null?l:ae(t,n,s,i,o))!=null?f:pe(t,n,i,o),!1]}class R{constructor(e){c(this,"ctx");c(this,"_map1",new Map);c(this,"_map2",new Map);c(this,"_map3",new Map);c(this,"_map4",new Map);c(this,"_counterMap",new Map);c(this,"_disposables",new Set);c(this,"_mapGet");c(this,"_mapSet");c(this,"_mapDelete");c(this,"_mapClear");c(this,"_counter",Number.MIN_SAFE_INTEGER);this.ctx=e;const t=e.unwrapResult(e.evalCode(`() => {
        const mapSym = new Map();
        let map = new WeakMap();
        let map2 = new WeakMap();
        const isObj = o => typeof o === "object" && o !== null || typeof o === "function";
        return {
          get: key => mapSym.get(key) ?? map.get(key) ?? map2.get(key) ?? -1,
          set: (key, value, key2) => {
            if (typeof key === "symbol") mapSym.set(key, value);
            if (isObj(key)) map.set(key, value);
            if (isObj(key2)) map2.set(key2, value);
          },
          delete: (key, key2) => {
            mapSym.delete(key);
            map.delete(key);
            map2.delete(key2);
          },
          clear: () => {
            mapSym.clear();
            map = new WeakMap();
            map2 = new WeakMap();
          }
        };
      }`)).consume(s=>this._call(s,void 0));this._mapGet=e.getProp(t,"get"),this._mapSet=e.getProp(t,"set"),this._mapDelete=e.getProp(t,"delete"),this._mapClear=e.getProp(t,"clear"),t.dispose(),this._disposables.add(this._mapGet),this._disposables.add(this._mapSet),this._disposables.add(this._mapDelete),this._disposables.add(this._mapClear)}set(e,t,s,r){var a;if(!t.alive||r&&!r.alive)return!1;const o=(a=this.get(e))!=null?a:this.get(s);if(o)return o===t||o===r;const i=this._counter++;return this._map1.set(e,i),this._map3.set(i,t),this._counterMap.set(i,e),s&&(this._map2.set(s,i),r&&this._map4.set(i,r)),this.ctx.newNumber(i).consume(u=>{this._call(this._mapSet,void 0,t,u,r!=null?r:this.ctx.undefined)}),!0}merge(e){if(e)for(const t of e)t&&t[1]&&this.set(t[0],t[1],t[2],t[3])}get(e){var r;const t=(r=this._map1.get(e))!=null?r:this._map2.get(e),s=typeof t=="number"?this._map3.get(t):void 0;if(s){if(!s.alive){this.delete(e);return}return s}}getByHandle(e){if(e.alive)return this._counterMap.get(this.ctx.getNumber(this._call(this._mapGet,void 0,e)))}has(e){return!!this.get(e)}hasHandle(e){return typeof this.getByHandle(e)!="undefined"}keys(){return this._map1.keys()}delete(e,t){var i;const s=(i=this._map1.get(e))!=null?i:this._map2.get(e);if(typeof s=="undefined")return;const r=this._map3.get(s),o=this._map4.get(s);this._call(this._mapDelete,void 0,...[r,o].filter(a=>!!(a!=null&&a.alive))),this._map1.delete(e),this._map2.delete(e),this._map3.delete(s),this._map4.delete(s);for(const[a,u]of this._map1)if(u===s){this._map1.delete(a);break}for(const[a,u]of this._map2)if(u===s){this._map2.delete(a);break}for(const[a,u]of this._counterMap)if(u===e){this._counterMap.delete(a);break}t&&(r!=null&&r.alive&&r.dispose(),o!=null&&o.alive&&o.dispose())}deleteByHandle(e,t){const s=this.getByHandle(e);typeof s!="undefined"&&this.delete(s,t)}clear(){this._counter=0,this._map1.clear(),this._map2.clear(),this._map3.clear(),this._map4.clear(),this._counterMap.clear(),this._mapClear.alive&&this._call(this._mapClear,void 0)}dispose(){for(const e of this._disposables.values())e.alive&&e.dispose();for(const e of this._map3.values())e.alive&&e.dispose();for(const e of this._map4.values())e.alive&&e.dispose();this._disposables.clear(),this.clear()}get size(){return this._map1.size}[Symbol.iterator](){const e=this._map1.keys();return{next:()=>{for(;;){const t=e.next();if(t.done)return{value:void 0,done:!0};const s=this._map1.get(t.value);if(typeof s=="undefined")continue;const r=this._map3.get(s),o=this._map4.get(s);if(!r)continue;const i=this._get2(s);return{value:[t.value,r,i,o],done:!1}}}}}_get2(e){for(const[t,s]of this._map2)if(s===e)return t}_call(e,t,...s){return this.ctx.unwrapResult(this.ctx.callFunction(e,typeof t=="undefined"?this.ctx.undefined:t,...s))}}function de(n,e,t,s,r,o,i){if(!g(e)||e instanceof Promise||e instanceof Date||i&&!i(e))return;if(he(e,t))return e;const a=new Proxy(e,{get(u,p){return p===t?u:Reflect.get(u,p)},set(u,p,l,f){var y;const d=P(l,t),h=(y=o==null?void 0:o(f))!=null?y:"host";return h!=="vm"&&!Reflect.set(u,p,d,f)||h==="host"||!n.alive||O([r(f),r(p),r(d)],(b,w,G)=>{const[J,_e]=M(n,b,s);_e?J.consume(be=>n.setProp(be,w,G)):n.setProp(J,w,G)}),!0},deleteProperty(u,p){var f;const l=(f=o==null?void 0:o(a))!=null?f:"host";return O([r(a),r(p)],(d,h)=>{const[y,b]=M(n,d,s);if(l==="vm"||Reflect.deleteProperty(u,p)){if(l==="host"||!n.alive)return!0;b?y.consume(w=>_(n,"(a, b) => delete a[b]",void 0,w,h)):_(n,"(a, b) => delete a[b]",void 0,y,h)}return!0})}});return a}function me(n,e,t,s,r,o,i){if(!F(n,e)||i&&!i(e,n))return[void 0,!1];if(I(n,e,s))return[e,!1];const a=l=>{const f=o==null?void 0:o(r(l));return typeof f=="string"?n.newString(f):n.undefined},u=(l,f,d)=>{const h=r(l);if(!h)return;const y=r(f);if(y==="__proto__")return;const b=r(d);P(h,t)[y]=b},p=(l,f)=>{const d=r(l);if(!d)return;const h=r(f);delete P(d,t)[h]};return n.newFunction("proxyFuncs",(l,...f)=>{switch(n.getNumber(l)){case 1:return a(f[0]);case 2:return u(f[0],f[1],f[2]);case 3:return p(f[0],f[1])}return n.undefined}).consume(l=>[_(n,`(target, sym, proxyFuncs) => {
          const rec =  new Proxy(target, {
            get(obj, key, receiver) {
              return key === sym ? obj : Reflect.get(obj, key, receiver)
            },
            set(obj, key, value, receiver) {
              const v = typeof value === "object" && value !== null || typeof value === "function"
                ? value[sym] ?? value
                : value;
              const sync = proxyFuncs(1, receiver) ?? "vm";
              if (sync === "host" || Reflect.set(obj, key, v, receiver)) {
                if (sync !== "vm") {
                  proxyFuncs(2, receiver, key, v);
                }
              }
              return true;
            },
            deleteProperty(obj, key) {
              const sync = proxyFuncs(1, rec) ?? "vm";
              if (sync === "host" || Reflect.deleteProperty(obj, key)) {
                if (sync !== "vm") {
                  proxyFuncs(3, rec, key);
                }
              }
              return true;
            },
          });
          return rec;
        }`,void 0,e,s,l),!0])}function P(n,e){var t;return g(n)&&(t=n[e])!=null?t:n}function M(n,e,t){return I(n,e,t)?[n.getProp(e,t),!0]:[e,!1]}function he(n,e){return g(n)&&!!n[e]}function I(n,e,t){return!!n.dump(_(n,'(a, s) => (a instanceof Promise) || (a instanceof Date) || (typeof a === "object" && a !== null || typeof a === "function") && !!a[s]',void 0,e,t))}class ye{constructor(e,t){c(this,"context");c(this,"_map");c(this,"_registeredMap");c(this,"_registeredMapDispose",new Set);c(this,"_sync",new Set);c(this,"_temporalSync",new Set);c(this,"_symbol",Symbol());c(this,"_symbolHandle");c(this,"_options");c(this,"_isMarshalable",e=>{var s,r;const t=(s=this._options)==null?void 0:s.isMarshalable;return(r=typeof t=="function"?t(this._unwrap(e)):t)!=null?r:"json"});c(this,"_marshalFind",e=>{var r,o,i;const t=this._unwrap(e);return(i=(o=(r=this._registeredMap.get(e))!=null?r:t!==e?this._registeredMap.get(t):void 0)!=null?o:this._map.get(e))!=null?i:t!==e?this._map.get(t):void 0});c(this,"_marshalPre",(e,t,s)=>{var r;if(s!=="json")return(r=this._register(e,Q(t),this._map))==null?void 0:r[1]});c(this,"_marshalPreApply",(e,t,s)=>{const r=g(t)?this._unwrap(t):void 0;r&&this._temporalSync.add(r);try{return e.apply(t,s)}finally{r&&this._temporalSync.delete(r)}});c(this,"_marshal",e=>{var r,o;const t=this._registeredMap.get(e);if(t)return[t,!1];const s=E((r=this._wrap(e))!=null?r:e,{ctx:this.context,unmarshal:this._unmarshal,isMarshalable:this._isMarshalable,find:this._marshalFind,pre:this._marshalPre,preApply:this._marshalPreApply,custom:(o=this._options)==null?void 0:o.customMarshaller});return[s,!this._map.hasHandle(s)]});c(this,"_preUnmarshal",(e,t)=>{var s;return(s=this._register(e,t,void 0,!0))==null?void 0:s[0]});c(this,"_unmarshalFind",e=>{var t;return(t=this._registeredMap.getByHandle(e))!=null?t:this._map.getByHandle(e)});c(this,"_unmarshal",e=>{var r;const t=this._registeredMap.getByHandle(e);if(typeof t!="undefined")return t;const[s]=this._wrapHandle(e);return B(s!=null?s:e,{ctx:this.context,marshal:this._marshal,find:this._unmarshalFind,pre:this._preUnmarshal,custom:(r=this._options)==null?void 0:r.customUnmarshaller})});c(this,"_syncMode",e=>{const t=this._unwrap(e);return this._sync.has(t)||this._temporalSync.has(t)?"both":void 0});c(this,"_unwrapIfNotSynced",e=>{const t=this._unwrap(e);return t instanceof Promise||!this._sync.has(t)?t:e});var s;t!=null&&t.compat&&!("runtime"in e)&&(e.runtime={hasPendingJob:()=>e.hasPendingJob(),executePendingJobs:r=>e.executePendingJobs(r)}),this.context=t!=null&&t.experimentalContextEx?v(e):e,this._options=t,this._symbolHandle=e.unwrapResult(e.evalCode("Symbol()")),this._map=new R(e),this._registeredMap=new R(e),this.registerAll((s=t==null?void 0:t.registeredObjects)!=null?s:k)}dispose(){var e,t;this._map.dispose(),this._registeredMap.dispose(),this._symbolHandle.dispose(),(t=(e=this.context).disposeEx)==null||t.call(e)}evalCode(e){const t=this.context.evalCode(e);return this._unwrapResultAndUnmarshal(t)}executePendingJobs(e){const t=this.context.runtime.executePendingJobs(e);if("value"in t)return t.value;throw this._unwrapIfNotSynced(t.error.consume(this._unmarshal))}expose(e){for(const[t,s]of Object.entries(e))$(this._marshal(s),r=>{this.context.setProp(this.context.global,t,r)})}sync(e){const t=this._wrap(e);return typeof t=="undefined"?e:(S(t,s=>{const r=this._unwrap(s);this._sync.add(r)}),t)}register(e,t){if(this._registeredMap.has(e))return;const s=typeof t=="string"?this._unwrapResult(this.context.evalCode(t)):t;C(this.context,s,this.context.undefined)||(typeof t=="string"&&this._registeredMapDispose.add(e),this._registeredMap.set(e,s))}registerAll(e){for(const[t,s]of e)this.register(t,s)}unregister(e,t){this._registeredMap.delete(e,this._registeredMapDispose.has(e)||t),this._registeredMapDispose.delete(e)}unregisterAll(e,t){for(const s of e)this.unregister(s,t)}startSync(e){if(!g(e))return;const t=this._unwrap(e);this._sync.add(t)}endSync(e){this._sync.delete(this._unwrap(e))}_unwrapResult(e){if("value"in e)return e.value;throw this._unwrapIfNotSynced(e.error.consume(this._unmarshal))}_unwrapResultAndUnmarshal(e){if(e)return this._unwrapIfNotSynced(this._unwrapResult(e).consume(this._unmarshal))}_register(e,t,s=this._map,r){if(this._registeredMap.has(e)||this._registeredMap.hasHandle(t))return;let o=this._wrap(e);const[i]=this._wrapHandle(t),a=e instanceof Promise;if(!i||!o&&!a)return;a&&(o=e);const u=this._unwrap(e),[p,l]=this._unwrapHandle(t);if(s.set(o,i,u,p))r&&this._sync.add(u);else throw l&&p.dispose(),new Error("already registered");return[o,i]}_wrap(e){var t;return de(this.context,e,this._symbol,this._symbolHandle,this._marshal,this._syncMode,(t=this._options)==null?void 0:t.isWrappable)}_unwrap(e){return P(e,this._symbol)}_wrapHandle(e){var t;return me(this.context,e,this._symbol,this._symbolHandle,this._unmarshal,this._syncMode,(t=this._options)==null?void 0:t.isHandleWrappable)}_unwrapHandle(e){return M(this.context,e,this._symbolHandle)}}m.Arena=ye,m.VMMap=R,m.call=_,m.complexity=Z,m.consumeAll=z,m.defaultRegisteredObjects=k,m.eq=C,m.isES2015Class=N,m.isHandleObject=F,m.isObject=g,m.json=H,m.marshal=E,m.unmarshal=B,m.walkObject=S,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
